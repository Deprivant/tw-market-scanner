/*! tw-market-scanner 0.0.1, Author: Deprivant 2021/11/21 */

var TWMarketScanner={SCRIPT_NAME:"TW Market Scanner",VERSION:"0.0.1",TIMER:6e5,MAX_OFFERS:10,NO_LIMIT:9999999,language:{cs:{ajaxErrorMessage:"Problém komunikace se serverem.",windowHeadline:"Nalezen produkt na trhu",closeButton:"Zavřít",noLimit:"bez limitu",limitCaption:"max. cena:",alreadyInstalled:"je již nainstalován",setting:"Nastavení",itemLabel:"Předmět č.",limitLabel:"Max. cena",saveButton:"Ulož",itemCaption:"Předmět",pricePerPieceCaption:"Cena za kus",piecesCaption:"Kusů",totalCaption:"Celkem"},en:{ajaxErrorMessage:"Connection problem with server.",windowHeadline:"Product found in the market",closeButton:"Close",noLimit:"no limit",limitCaption:"max price:",alreadyInstalled:"is already installed",setting:"Setting",itemLabel:"Item #",limitLabel:"Max price",saveButton:"Save",itemCaption:"Item",pricePerPieceCaption:"PPP",piecesCaption:"Pieces",totalCaption:"Total"}},setStyle:function(){$("<style>").text(".twms-text-left{text-align:left}.twms-text-right{text-align:right}.twms-text-center{text-align:center}.twms-table-wrapper{height:50%;max-height:350px;max-width:400px;overflow-y:auto}.twms-table{width:100%;padding-right:5px;margin-bottom:10px}.twms-caption{text-align:left;margin-bottom:5px;font-weight:700}.twms-th-image{width:5%;min-width:30px}.twms-th-item{width:50%;text-align:left}.twms-th-ppp{width:18%;text-align:right}.twms-th-pieces{width:11%;text-align:center}.twms-th-sum{width:18%;text-align:right}.twms-table th{font-size:11px}.twms-table td{vertical-align:middle}.twms-item-image{width:30px}.twms-form-row .tw2gui_textfield_label{width:80px;display:inline-block;margin-left:10px}#TWMS-menuLink{text-align:center;background-image:url(data:image/png;base64,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)}#TWMS-menuLink:hover{background-position:-25px 0}#TWMS-menuLink svg{margin-top:3px;width:20px}.twsm-infoText{margin:10px 0 0 10px;font-size:11px}.twsm-buttonsWrapper{width:96%;text-align:right;margin-top:10px}").appendTo(document.head)},getLanguage:function(){return"cs_CZ"===Game.locale?"cs":"en"},startTimer:function(){TWMarketScanner.timer=setTimeout(function(){TWMarketScanner.getAllScans(),TWMarketScanner.startTimer()},TWMarketScanner.TIMER)},stopTimer:function(){clearTimeout(TWMarketScanner.timer)},scanMarket:function(e){return"string"!=typeof e||""===e?null:Ajax.remoteCall("building_market","search",{pattern:e},function(e){if(e.error)return MessageError(TWMarketScanner.language[TWMarketScanner.getLanguage()].ajaxErrorMessage).show(),null})},getAllScans:function(){var r=JSON.parse(localStorage.getItem("twms_settings"));if(!r)return null;$.when(TWMarketScanner.scanMarket(r[0].searchText),TWMarketScanner.scanMarket(r[1].searchText),TWMarketScanner.scanMarket(r[2].searchText),TWMarketScanner.scanMarket(r[3].searchText),TWMarketScanner.scanMarket(r[4].searchText),TWMarketScanner.scanMarket(r[5].searchText),TWMarketScanner.scanMarket(r[6].searchText),TWMarketScanner.scanMarket(r[7].searchText),TWMarketScanner.scanMarket(r[8].searchText),TWMarketScanner.scanMarket(r[9].searchText)).done(function(...t){var a=[];for(let e=0;e<t.length;e+=1)t[e]?a.push(0<t[e][0].msg.search_result.length?t[e][0].msg.search_result:null):a.push(null);if(a.filter(function(e){return null===e}).length===TWMarketScanner.MAX_OFFERS)return null;var n=$("<div class='twms-table-wrapper' />");for(let e=0;e<a.length;e+=1)n.append(TWMarketScanner.generateTable(a[e],r[e].searchText,r[e].limit));var e=new west.gui.Dialog(TWMarketScanner.language[TWMarketScanner.getLanguage()].windowHeadline);e.setText(n),e.addButton(TWMarketScanner.language[TWMarketScanner.getLanguage()].closeButton),e.show()})},getItemName:function(e){e=ItemManager.get(String(e));return{name:e.name,imageUrl:e.image}},generateTable:function(t,e,a){if(e=e||"",!t)return"";var n,r,i,s,g,l,c,o,m;"0"!==a&&""!==a||(a=TWMarketScanner.NO_LIMIT),i=$("<table class='twms-table' />"),m=a===TWMarketScanner.NO_LIMIT?TWMarketScanner.language[TWMarketScanner.getLanguage()].noLimit:format_money(a),e=$("<caption class='twms-caption'>"+e+" ("+TWMarketScanner.language[TWMarketScanner.getLanguage()].limitCaption+" "+m+")</caption>"),m=$("<thead><tr><th class='twms-th-image'></th><th class='twms-th-item'>"+TWMarketScanner.language[TWMarketScanner.getLanguage()].itemCaption+"<th class='twms-th-ppp'>"+TWMarketScanner.language[TWMarketScanner.getLanguage()].pricePerPieceCaption+"</th><th class='twms-th-pieces'>"+TWMarketScanner.language[TWMarketScanner.getLanguage()].piecesCaption+"</th><th class='twms-th-sum'>"+TWMarketScanner.language[TWMarketScanner.getLanguage()].totalCaption+"</th></tr></thead>"),i.append(e),i.append(m),o=!1;for(let e=0;e<t.length;e+=1)c=t[e].auction_price,s=t[e].max_price,n=t[e].item_count,l=t[e].item_id,r=c/n,g=s/n,l=TWMarketScanner.getItemName(l),g=r||g,c=c||s,s=$("<tr/>"),Number(a)>=Number(g)&&(c=$("<td><img class='twms-item-image' src='"+l.imageUrl+"' /></td><td class='twms-text-left'>"+l.name+"<td class='twms-text-right'>$"+format_money(g)+"</td><td class='twms-text-center'>"+format_number(n)+"</td><td class='twms-text-right'>$"+format_money(c)+"</td>"),o=!0,s.append(c),i.append(s));return i=!o?"":i},init:function(){var e,t,a;$("#TWMS-menuLink").length?MessageError(TWMarketScanner.SCRIPT_NAME+" "+TWMarketScanner.language[TWMarketScanner.getLanguage()].alreadyInstalled).show():(TWMarketScanner.setStyle(),e=$('<div class="ui_menucontainer">/'),(t=$('<div id="TWMS-menuLink" class="menulink"><svg viewBox="0 0 24 24"><path fill="lightgray" d="M19.74 18.33C21.15 16.6 22 14.4 22 12c0-5.52-4.48-10-10-10S2 6.48 2 12s4.48 10 10 10c2.4 0 4.6-.85 6.33-2.26.27-.22.53-.46.78-.71.03-.03.05-.06.07-.08.2-.2.39-.41.56-.62zM12 20c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8c0 1.85-.63 3.54-1.69 4.9l-1.43-1.43c.69-.98 1.1-2.17 1.1-3.46 0-3.31-2.69-6-6-6s-6 2.69-6 6 2.69 6 6 6c1.3 0 2.51-.42 3.49-1.13l1.42 1.42C15.54 19.37 13.85 20 12 20zm1.92-7.49c.17-.66.02-1.38-.49-1.9l-.02-.02c-.77-.77-2-.78-2.78-.04-.01.01-.03.02-.05.04-.78.78-.78 2.05 0 2.83l.02.02c.52.51 1.25.67 1.91.49l1.51 1.51c-.6.36-1.29.58-2.04.58-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4c0 .73-.21 1.41-.56 2l-1.5-1.51z"></path></svg></div>')).click(function(){TWMarketScanner.showSetting()}),a=$('<div class="menucontainer_bottom">/'),e.append(t),e.append(a),$("#ui_menubar").append(e),TWMarketScanner.getAllScans(),TWMarketScanner.startTimer())},showSetting:function(){var t,a,e,n,r,i,s,g=JSON.parse(localStorage.getItem("twms_settings")),l=wman.open("twms-setting",null).setMiniTitle(TWMarketScanner.language[TWMarketScanner.getLanguage()].setting).setTitle(TWMarketScanner.language[TWMarketScanner.getLanguage()].setting).setMinSize(550,458).setSize(550,458),c=$("<div />");for(let e=0;e<10;e+=1)t=$("<div class='twms-form-row'/>"),(a=new west.gui.Textfield("item-"+(e+1))).setLabel(TWMarketScanner.language[TWMarketScanner.getLanguage()].itemLabel+(e+1)),a.setId("twms-item-"+(e+1)),a.setSize(20),a.maxlength(50),g&&a.setValue(g[e].searchText),t.append(a.getMainDiv()),(a=new west.gui.Textfield("limit-"+(e+1))).setLabel(TWMarketScanner.language[TWMarketScanner.getLanguage()].limitLabel),a.setSize(9),a.maxlength(9),a.onlyNumeric(),a.setId("twms-limit-"+(e+1)),g&&a.setValue(g[e].limit),t.append(a.getMainDiv()),c.append(t);e=$("<div class='twsm-buttonsWrapper' />"),n=new west.gui.Button(TWMarketScanner.language[TWMarketScanner.getLanguage()].saveButton,function(){var t=[];for(let e=0;e<10;e+=1)r=$("#twms-item-"+(e+1)).val().trim(),i=$("#twms-limit-"+(e+1)).val().trim(),t.push({searchText:r,limit:i});localStorage.setItem("twms_settings",JSON.stringify(t)),TWMarketScanner.stopTimer(),TWMarketScanner.getAllScans(),TWMarketScanner.startTimer(),l.destroy()}),s=new west.gui.Button(TWMarketScanner.language[TWMarketScanner.getLanguage()].closeButton,function(){l.destroy()}),e.append(n.getMainDiv(),s.getMainDiv()),n=$("<span class='twsm-infoText'>"+TWMarketScanner.SCRIPT_NAME+" v. "+TWMarketScanner.VERSION+"</span>"),(s=new west.gui.Scrollpane).appendContent(c),s.appendContent(e),s.appendContent(n),l.appendToContentPane(s.getMainDiv())}};$(document).ready(function(){try{TWMarketScanner.init()}catch(e){console.log(e.stack)}});