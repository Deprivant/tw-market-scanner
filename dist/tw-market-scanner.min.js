/*! tw-market-scanner 1.1.0, Author: Deprivant 2021/11/23  https://deprivant.github.io/tw-market-scanner/ */

var TWMarketScanner={SCRIPT_NAME:"TW Market Scanner",VERSION:"1.1.0",TIMER:6e5,MAX_OFFERS:10,NO_LIMIT:9999999,SETTING_PREFIX:"twms_settings_"+Game.worldName,power:void 0,setting:void 0,language:{cs:{ajaxErrorMessage:"Problém komunikace se serverem.",windowHeadline:"Nalezen produkt na trhu",closeButton:"Zavřít",noLimit:"bez limitu",limitCaption:"max. cena:",alreadyInstalled:"je již nainstalován",setting:"Nastavení",itemLabel:"Předmět č.",limitLabel:"Max. cena",saveButton:"Ulož",itemCaption:"Předmět",pricePerPieceCaption:"Cena za kus",piecesCaption:"Kusů",totalCaption:"Celkem",worldError:"Problém s detekcí světa",checkboxPowerLabel:"Skenování trhu je aktivní",checkboxPowerTooltip:"Zapne/vypne automatické skenování trhu podle požadovaného nastavení"},en:{ajaxErrorMessage:"Connection problem with server.",windowHeadline:"Product found in the market",closeButton:"Close",noLimit:"no limit",limitCaption:"max price:",alreadyInstalled:"is already installed",setting:"Setting",itemLabel:"Item #",limitLabel:"Max price",saveButton:"Save",itemCaption:"Item",pricePerPieceCaption:"PPP",piecesCaption:"Pieces",totalCaption:"Total",worldError:"Problem with world name",checkboxPowerLabel:"Market scanner is active",checkboxPowerTooltip:"Start/stop automatic market scanner"}},setStyle:function(){$("<style>").text(".twms-text-left{text-align:left}.twms-text-right{text-align:right}.twms-text-center{text-align:center}.twms-table-wrapper{height:50%;max-height:350px;max-width:400px;overflow-y:auto}.twms-table{width:100%;padding-right:5px;margin-bottom:10px}.twms-caption{text-align:left;margin-bottom:5px;font-weight:700}.twms-th-image{width:5%;min-width:30px}.twms-th-item{width:50%;text-align:left}.twms-th-ppp{width:18%;text-align:right}.twms-th-pieces{width:11%;text-align:center}.twms-th-sum{width:18%;text-align:right}.twms-table th{font-size:11px}.twms-table td{vertical-align:middle}.twms-item-image{width:30px}.twms-form-row .tw2gui_textfield_label{width:80px;display:inline-block;margin-left:10px}#twms-checkbox-power{margin-bottom:10px;margin-left:10px}#TWMS-menuLink{text-align:center;background-image:url(data:image/png;base64,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)}#TWMS-menuLink:hover{background-position:-25px 0}#TWMS-menuLink svg{margin-top:3px;width:20px;fill:lightgray}#TWMS-menuLink svg{margin-top:3px;width:20px}#TWMS-menuLink svg path{fill:lightgray}#TWMS-menuLink.power-off svg path{fill:dimgrey}.twsm-infoText{margin:10px 0 0 10px;font-size:11px}.twsm-buttonsWrapper{width:96%;text-align:right;margin-top:10px}").appendTo(document.head)},getLanguage:function(){return"cs_CZ"===Game.locale?"cs":"en"},openMarket:function(e){var t;TWMarketScanner.resultWindow.hide(),t=$(e).data("city"),e=$(e).data("search"),MarketWindow.open(t),MarketWindow.showTab("buy"),$("div.market-buy .iSearchbox input",MarketWindow.DOM).val(e);e=$.Event("keypress");e.which=13,e.keyCode=13,$("div.market-buy .iSearchbox input",MarketWindow.DOM).trigger(e)},getSetting:function(){var t=[],e=JSON.parse(localStorage.getItem(TWMarketScanner.SETTING_PREFIX));if(e)TWMarketScanner.power="off"!==e.power,TWMarketScanner.setting=e.setting;else{for(let e=0;e<TWMarketScanner.MAX_OFFERS;e+=1)t.push({searchText:"",limit:""});TWMarketScanner.setting=t,TWMarketScanner.power=!0,localStorage.setItem(TWMarketScanner.SETTING_PREFIX,JSON.stringify({power:"on",setting:t}))}},startTimer:function(){TWMarketScanner.timer=setTimeout(function(){TWMarketScanner.getAllScans(),TWMarketScanner.startTimer()},TWMarketScanner.TIMER)},stopTimer:function(){clearTimeout(TWMarketScanner.timer)},scanMarket:function(e){return"string"!=typeof e||""===e?null:Ajax.remoteCall("building_market","search",{pattern:e},function(e){if(e.error)return MessageError(TWMarketScanner.language[TWMarketScanner.getLanguage()].ajaxErrorMessage).show(),null})},getAllScans:function(){var S,e=JSON.parse(localStorage.getItem(TWMarketScanner.SETTING_PREFIX));return e&&"on"===e.power?(S=e.setting,void $.when(TWMarketScanner.scanMarket(S[0].searchText),TWMarketScanner.scanMarket(S[1].searchText),TWMarketScanner.scanMarket(S[2].searchText),TWMarketScanner.scanMarket(S[3].searchText),TWMarketScanner.scanMarket(S[4].searchText),TWMarketScanner.scanMarket(S[5].searchText),TWMarketScanner.scanMarket(S[6].searchText),TWMarketScanner.scanMarket(S[7].searchText),TWMarketScanner.scanMarket(S[8].searchText),TWMarketScanner.scanMarket(S[9].searchText)).done(function(...e){var t,a,n,r,i,s,c,o,g,l=[];for(TWMarketScanner.resultWindow=new west.gui.Dialog(TWMarketScanner.language[TWMarketScanner.getLanguage()].windowHeadline),T=0;T<e.length;T+=1)if(e[T]&&0<e[T][0].msg.search_result.length){for(n=e[T][0].msg.search_result,t={},c=0===Number(S[T].limit)?TWMarketScanner.NO_LIMIT:S[T].limit,o=!1,g=0;g<n.length;g+=1)i=n[g].current_bid/n[g].item_count,s=n[g].max_price/n[g].item_count,a=i||s,n[g].item_count,n[g].item_id,Number(c)>=Number(a)&&(o=!0,r=n[g].item_count,i=n[g].item_id,s=n[g].current_bid||n[g].max_price,t[g]={itemId:i,pricePerPiece:a,itemCount:r,totalPrice:s});o&&l.push({setting:{searchText:S[T].searchText,limit:c},items:t})}if(0!==l.length){for(var m=$("<div class='twms-table-wrapper' />"),T=0;T<l.length;T+=1)m.append(TWMarketScanner.generateTable(l[T]));TWMarketScanner.resultWindow.setText(m),TWMarketScanner.resultWindow.addButton(TWMarketScanner.language[TWMarketScanner.getLanguage()].closeButton).setId("TWMS-result-button"),TWMarketScanner.resultWindow.show()}})):null},getItemName:function(e){e=ItemManager.get(String(e));return{name:e.name,imageUrl:e.image}},generateTable:function(e){var a,n,r,i,s,c,t=e.setting,o=e.items,g=Character.homeTown.town_id,e=t.limit,t=t.searchText,l=$("<table class='twms-table' />"),e=e===TWMarketScanner.NO_LIMIT?TWMarketScanner.language[TWMarketScanner.getLanguage()].noLimit:format_money(e),t=$("<caption class='twms-caption'>"+t+" ("+TWMarketScanner.language[TWMarketScanner.getLanguage()].limitCaption+" "+e+")</caption>"),e=$("<thead><tr><th class='twms-th-image'></th><th class='twms-th-item'>"+TWMarketScanner.language[TWMarketScanner.getLanguage()].itemCaption+"<th class='twms-th-ppp'>"+TWMarketScanner.language[TWMarketScanner.getLanguage()].pricePerPieceCaption+"</th><th class='twms-th-pieces'>"+TWMarketScanner.language[TWMarketScanner.getLanguage()].piecesCaption+"</th><th class='twms-th-sum'>"+TWMarketScanner.language[TWMarketScanner.getLanguage()].totalCaption+"</th></tr></thead>");return l.append(t),l.append(e),$.each(o,function(e,t){a=TWMarketScanner.getItemName(t.itemId),i=t.pricePerPiece,n=t.itemCount,c=t.totalPrice,s=$("<tr/>"),r=g?'<a href="#" onClick="TWMarketScanner.openMarket(this)" data-city="'+g+'" data-search="'+a.name+'">'+a.name+"</a>":a.name,c=$("<td><img class='twms-item-image' src='"+a.imageUrl+"' /></td><td class='twms-text-left'>"+r+"<td class='twms-text-right'>$"+format_money(i)+"</td><td class='twms-text-center'>"+format_number(n)+"</td><td class='twms-text-right'>$"+format_money(c)+"</td>"),s.append(c),l.append(s)}),l},init:function(){var e,t,a;$("#TWMS-menuLink").length?MessageError(TWMarketScanner.SCRIPT_NAME+" "+TWMarketScanner.language[TWMarketScanner.getLanguage()].alreadyInstalled).show():TWMarketScanner.SETTING_PREFIX.length<1?MessageError(TWMarketScanner.language[TWMarketScanner.getLanguage()].worldError).show():(TWMarketScanner.getSetting(),TWMarketScanner.setStyle(),e=$('<div class="ui_menucontainer">/'),(t=$('<div id="TWMS-menuLink" class="menulink" title="'+TWMarketScanner.SCRIPT_NAME+'" ><svg viewBox="0 0 24 24"><path fill="lightgray" d="M19.74 18.33C21.15 16.6 22 14.4 22 12c0-5.52-4.48-10-10-10S2 6.48 2 12s4.48 10 10 10c2.4 0 4.6-.85 6.33-2.26.27-.22.53-.46.78-.71.03-.03.05-.06.07-.08.2-.2.39-.41.56-.62zM12 20c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8c0 1.85-.63 3.54-1.69 4.9l-1.43-1.43c.69-.98 1.1-2.17 1.1-3.46 0-3.31-2.69-6-6-6s-6 2.69-6 6 2.69 6 6 6c1.3 0 2.51-.42 3.49-1.13l1.42 1.42C15.54 19.37 13.85 20 12 20zm1.92-7.49c.17-.66.02-1.38-.49-1.9l-.02-.02c-.77-.77-2-.78-2.78-.04-.01.01-.03.02-.05.04-.78.78-.78 2.05 0 2.83l.02.02c.52.51 1.25.67 1.91.49l1.51 1.51c-.6.36-1.29.58-2.04.58-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4c0 .73-.21 1.41-.56 2l-1.5-1.51z"></path></svg></div>')).click(function(){TWMarketScanner.showSetting()}),a=$('<div class="menucontainer_bottom">/'),e.append(t),e.append(a),$("#ui_menubar").append(e),TWMarketScanner.power||$("#TWMS-menuLink").addClass("power-off"),TWMarketScanner.getAllScans(),TWMarketScanner.startTimer())},showSetting:function(){var e,t,a,n,r,i,s,c=TWMarketScanner.setting,o=wman.open("twms-setting",null).setMiniTitle(TWMarketScanner.language[TWMarketScanner.getLanguage()].setting).setTitle(TWMarketScanner.language[TWMarketScanner.getLanguage()].setting).setMinSize(550,490).setSize(550,490),g=$("<div />"),l=new west.gui.Checkbox(TWMarketScanner.language[TWMarketScanner.getLanguage()].checkboxPowerLabel).setId("twms-checkbox-power").setTooltip(TWMarketScanner.language[TWMarketScanner.getLanguage()].checkboxPowerTooltip).setSelected(TWMarketScanner.power);g.append(l.getMainDiv());for(let e=0;e<TWMarketScanner.MAX_OFFERS;e+=1)n=$("<div class='twms-form-row'/>"),(t=new west.gui.Textfield("item-"+(e+1))).setLabel(TWMarketScanner.language[TWMarketScanner.getLanguage()].itemLabel+(e+1)),t.setId("twms-item-"+(e+1)),t.setSize(20),t.maxlength(50),c&&t.setValue(c[e].searchText),n.append(t.getMainDiv()),(t=new west.gui.Textfield("limit-"+(e+1))).setLabel(TWMarketScanner.language[TWMarketScanner.getLanguage()].limitLabel),t.setSize(9),t.maxlength(9),t.onlyNumeric(),t.setId("twms-limit-"+(e+1)),c&&t.setValue(c[e].limit),n.append(t.getMainDiv()),g.append(n);e=$("<div class='twsm-buttonsWrapper' />"),r=new west.gui.Button(TWMarketScanner.language[TWMarketScanner.getLanguage()].saveButton,function(){for(var e=[],t=0;t<TWMarketScanner.MAX_OFFERS;t+=1)s=$("#twms-item-"+(t+1)).val().trim(),a=$("#twms-limit-"+(t+1)).val().trim(),e.push({searchText:s,limit:a});localStorage.setItem(TWMarketScanner.SETTING_PREFIX,JSON.stringify({power:l.isSelected()?"on":"off",setting:e})),TWMarketScanner.setting=e,TWMarketScanner.power=l.isSelected(),TWMarketScanner.stopTimer(),l.isSelected()?($("#TWMS-menuLink").removeClass("power-off"),TWMarketScanner.getAllScans(),TWMarketScanner.startTimer()):$("#TWMS-menuLink").addClass("power-off"),o.destroy()}),i=new west.gui.Button(TWMarketScanner.language[TWMarketScanner.getLanguage()].closeButton,function(){o.destroy()}),e.append(r.getMainDiv(),i.getMainDiv()),r=$("<span class='twsm-infoText'>"+TWMarketScanner.SCRIPT_NAME+" v. "+TWMarketScanner.VERSION+"</span>"),(i=new west.gui.Scrollpane).appendContent(g),i.appendContent(e),i.appendContent(r),o.appendToContentPane(i.getMainDiv())}};$(document).ready(function(){try{TWMarketScanner.init()}catch(e){console.log(e.stack)}});